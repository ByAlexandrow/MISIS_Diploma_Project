<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Анализ DataFrame и построение графиков</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        label { display: block; margin-top: 1em; }
        button { margin-top: 0.5em; }
        pre { background: #f4f4f4; padding: 1em; white-space: pre-wrap; font-family: monospace; line-height: 1.4; }
        table { border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid #ccc; padding: 0.4em 0.6em; }
        #plot-image { display:none; margin-top: 1em; max-width: 80%; border: 1px solid #ccc; padding: 5px; }
        #df-head-wrapper {
            overflow-x: auto;
            max-width: 100%;
            margin-top: 1em;
        }
        #columns-wrapper {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 0.5em;
        }
        #columns-wrapper label {
            cursor: pointer;
            padding: 5px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            user-select: none;
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        #columns-wrapper label:hover {
            background-color: #e0e0e0;
        }
        #columns-wrapper input[type="radio"] {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Загрузите CSV файл с DataFrame</h1>
    <input type="file" id="file-input" accept=".csv" />
    <button id="analyze-btn">Проанализировать</button>

    <h2>Информация о DataFrame</h2>
    <pre id="df-info"></pre>

    <h2>Первые 10 строк</h2>
    <div id="df-head-wrapper">
        <table id="df-head"></table>
    </div>

    <h2>Выберите колонку для графика</h2>
    <div id="columns-wrapper"></div>

    <h2>Выберите колонку для группировки</h2>
    <div id="group-by-message" style="font-style: italic; color: gray; margin-top: 0.5em;">
        Пока в разработке
    </div>


    <h2>Выберите тип графика</h2>
    <select id="chart-type">
        <option value="bar">Столбчатый вертикальный</option>
        <option value="barh">Столбчатый горизонтальный (в разработке)</option>
        <option value="pie">Круговой (в разработке)</option>
    </select>

    <br/>
    <button id="plot-btn">Построить график</button>
    <button id="download-pdf-btn" style="display:none;">Скачать PDF</button>

    <img id="plot-image" alt="График" />

    <script>
        let uploadedFile = null;

        document.getElementById("file-input").addEventListener("change", (e) => {
            uploadedFile = e.target.files[0];
            clearUI();
        });

        document.getElementById("analyze-btn").addEventListener("click", async () => {
            if (!uploadedFile) {
                alert("Выберите файл сначала");
                return;
            }

            let formData = new FormData();
            formData.append("file", uploadedFile);

            const res = await fetch("/api/upload/", { method: "POST", body: formData });

            if (!res.ok) {
                alert("Ошибка при загрузке файла");
                return;
            }

            const data = await res.json();

            if (data.error) {
                alert(data.error);
                return;
            }
            document.getElementById("df-info").textContent = data.info;

            let table = document.getElementById("df-head");
            table.innerHTML = "";
            if(data.head.length > 0){
                let headerRow = document.createElement("tr");
                Object.keys(data.head[0]).forEach(col => {
                    let th = document.createElement("th");
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                data.head.forEach(row => {
                    let tr = document.createElement("tr");
                    Object.values(row).forEach(val => {
                        let td = document.createElement("td");
                        td.textContent = val;
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
            }

            let columnsWrapper = document.getElementById("columns-wrapper");
            columnsWrapper.innerHTML = "";
            data.columns.forEach((col, idx) => {
                let label = document.createElement("label");
                if(idx === 0) label.classList.add("selected");
                let input = document.createElement("input");
                input.type = "radio";
                input.name = "columns-select";
                input.value = col;
                if(idx === 0) input.checked = true;
                let span = document.createElement("span");
                span.textContent = col;
                label.appendChild(input);
                label.appendChild(span);
                columnsWrapper.appendChild(label);
            });
        });

        document.getElementById("plot-btn").addEventListener("click", async () => {
            if(!uploadedFile) { alert("Выберите файл сначала"); return; }
            let selectedRadio = document.querySelector('input[name="columns-select"]:checked');
            if(!selectedRadio) { alert("Выберите колонку для графика"); return; }
            let selected = selectedRadio.value;

            let groupSelected = ""; // заглушка, функционал в разработке

            let chartType = document.getElementById("chart-type").value;

            let formData = new FormData();
            formData.append("file", uploadedFile);
            formData.append("selected_column", selected);
            formData.append("group_by_column", groupSelected);
            formData.append("chart_type", chartType);

            const res = await fetch("/api/plot/image/", {method: "POST", body: formData});
            if(!res.ok) {
                let errorData = await res.json();
                alert(errorData.error || "Ошибка построения графика");
                return;
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);

            let plotImage = document.getElementById("plot-image");
            plotImage.src = url;
            plotImage.style.display = "block";

            document.getElementById("download-pdf-btn").style.display = "inline-block";
            });


        document.getElementById("download-pdf-btn").addEventListener("click", async () => {
            if (!uploadedFile) {
                alert("Выберите файл сначала");
                return;
            }
            let selectedRadio = document.querySelector('input[name="columns-select"]:checked');
            if(!selectedRadio) {
                alert("Выберите колонку для графика");
                return;
            }
            let selected = selectedRadio.value;

            let groupSelect = document.getElementById("group-by-select");
            let groupSelected = groupSelect.value || "";

            let chartType = document.getElementById("chart-type").value;

            let formData = new FormData();
            formData.append("file", uploadedFile);
            formData.append("selected_column", selected);
            formData.append("group_by_column", groupSelected);
            formData.append("chart_type", chartType);

            const res = await fetch("/api/plot/pdf/", { method: "POST", body: formData });
            if (!res.ok) {
                let errorData = await res.json();
                alert(errorData.error || "Ошибка скачивания PDF");
                return;
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "plot.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        function clearUI(){
            document.getElementById("df-info").textContent = "";
            document.getElementById("df-head").innerHTML = "";
            document.getElementById("columns-wrapper").innerHTML = "";
            document.getElementById("group-by-select").innerHTML = "";
            document.getElementById("plot-image").style.display = "none";
            document.getElementById("download-pdf-btn").style.display = "none";
        }
    </script>
</body>
</html>
