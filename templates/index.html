<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Анализ DataFrame и построение графиков</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        label { display: block; margin-top: 1em; }
        select, button { margin-top: 0.5em; }
        pre { background: #f4f4f4; padding: 1em; white-space: pre-wrap; max-height: 200px; overflow-y: auto;}
        table { border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid #ccc; padding: 0.4em 0.6em; }
        #plot-download { margin-top: 1em; display: none; }
        #plot-image { display:none; margin-top: 1em; max-width: 80%; border: 1px solid #ccc; padding: 5px; }
    </style>
</head>
<body>
    <h1>Загрузите CSV файл с DataFrame</h1>
    <input type="file" id="file-input" accept=".csv" />
    <button id="analyze-btn">Проанализировать</button>

    <h2>Информация о DataFrame</h2>
    <pre id="df-info"></pre>

    <h2>Первые 10 строк</h2>
    <table id="df-head"></table>

    <h2>Выберите колонки для графика</h2>
    <select id="columns-select" multiple size="6" style="width: 300px;"></select>

    <h2>Выберите тип графика</h2>
    <select id="chart-type">
        <option value="bar">Столбчатый вертикальный</option>
        <option value="barh">Столбчатый горизонтальный</option>
        <option value="pie">Круговой</option>
    </select>

    <br/>
    <button id="plot-btn">Построить график</button>
    <button id="download-pdf-btn" style="display:none;">Скачать PDF</button>

    <img id="plot-image" alt="График" />

    <script>
        let uploadedFile = null;

        document.getElementById("file-input").addEventListener("change", (e) => {
            uploadedFile = e.target.files[0];
            clearUI();
        });

        document.getElementById("analyze-btn").addEventListener("click", async () => {
            if (!uploadedFile) {
                alert("Выберите файл сначала");
                return;
            }

            let formData = new FormData();
            formData.append("file", uploadedFile);

            const res = await fetch("/api/upload/", { method: "POST", body: formData });

            if (!res.ok) {
                alert("Ошибка при загрузке файла");
                return;
            }

            const data = await res.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            document.getElementById("df-info").textContent = data.info;

            let table = document.getElementById("df-head");
            table.innerHTML = "";
            if(data.head.length > 0){
                let headerRow = document.createElement("tr");
                Object.keys(data.head[0]).forEach(col => {
                    let th = document.createElement("th");
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                data.head.forEach(row => {
                    let tr = document.createElement("tr");
                    Object.values(row).forEach(val => {
                        let td = document.createElement("td");
                        td.textContent = val;
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
            }

            let columnsSelect = document.getElementById("columns-select");
            columnsSelect.innerHTML = "";
            data.columns.forEach(col => {
                let option = document.createElement("option");
                option.value = col;
                option.textContent = col;
                columnsSelect.appendChild(option);
            });
        });

        document.getElementById("plot-btn").addEventListener("click", async () => {
            if (!uploadedFile) {
                alert("Выберите файл сначала");
                return;
            }
            let select = document.getElementById("columns-select");
            let selected = Array.from(select.selectedOptions).map(o => o.value);
            if (selected.length === 0) {
                alert("Выберите хотя бы одну колонку для графика");
                return;
            }
            let chartType = document.getElementById("chart-type").value;

            let formData = new FormData();
            formData.append("file", uploadedFile);
            formData.append("selected_columns", selected.join(","));
            formData.append("chart_type", chartType);

            const res = await fetch("/api/plot/image/", { method: "POST", body: formData });
            if (!res.ok) {
                let errorData = await res.json();
                alert(errorData.error || "Ошибка построения графика");
                return;
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            let plotImage = document.getElementById("plot-image");
            plotImage.src = url;
            plotImage.style.display = "block";

            document.getElementById("download-pdf-btn").style.display = "inline-block";
        });

        document.getElementById("download-pdf-btn").addEventListener("click", async () => {
            if (!uploadedFile) {
                alert("Выберите файл сначала");
                return;
            }
            let select = document.getElementById("columns-select");
            let selected = Array.from(select.selectedOptions).map(o => o.value);
            if (selected.length === 0) {
                alert("Выберите хотя бы одну колонку для графика");
                return;
            }
            let chartType = document.getElementById("chart-type").value;

            let formData = new FormData();
            formData.append("file", uploadedFile);
            formData.append("selected_columns", selected.join(","));
            formData.append("chart_type", chartType);

            const res = await fetch("/api/plot/pdf/", { method: "POST", body: formData });
            if (!res.ok) {
                let errorData = await res.json();
                alert(errorData.error || "Ошибка скачивания PDF");
                return;
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "plot.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        function clearUI(){
            document.getElementById("df-info").textContent = "";
            document.getElementById("df-head").innerHTML = "";
            document.getElementById("columns-select").innerHTML = "";
            document.getElementById("plot-image").style.display = "none";
            document.getElementById("download-pdf-btn").style.display = "none";
        }
    </script>
</body>
</html>
